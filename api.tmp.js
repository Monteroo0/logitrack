const API_BASE=(typeof window!=='undefined'&&window.location&&window.location.origin)?window.location.origin:'http://localhost:8080';
function buildUrl(url){return /^https?:\/\//.test(url)?url:API_BASE+url}
async function apiRequest(method,url,body){const headers={'Content-Type':'application/json'};const token=localStorage.getItem('token');const isAuthPath=/^\s*\/auth\//.test(url);if(token&&!isAuthPath){headers['Authorization']='Bearer '+token}const res=await fetch(buildUrl(url),{method,headers,body:body?JSON.stringify(body):undefined});let data=null;try{data=await res.json()}catch(e){}if(res.status===401){if(!isAuthPath){localStorage.removeItem('token')}throw new Error('Credenciales inv√°lidas')}if(!res.ok){const err=(data&&data.message)||'Error en la solicitud';throw new Error(err)}return data}