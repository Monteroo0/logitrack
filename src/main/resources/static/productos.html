<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LogiTrack - Gestión de Productos</title>
<link rel="stylesheet" href="css/styles.css">
<style>
.panel{background:#FFFFFF;border:1px solid #DDDDDD;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.08);max-width:1200px;margin:24px auto;padding:24px}
.panel h2{margin-top:0;color:#0A1A2F}
.table{width:100%;border-collapse:collapse;margin-top:16px}
.table th,.table td{padding:12px;text-align:left;border-bottom:1px solid #DDDDDD}
.table th{background:#F5F9FF;color:#0A1A2F;font-weight:600}
.btn.small{padding:6px 12px;font-size:14px;height:auto}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:4px;font-weight:600;color:#0A1A2F}
.form-group input,.form-group select{width:100%;padding:8px;border:1px solid #DDDDDD;border-radius:4px}
.form-actions{display:flex;gap:12px;justify-content:flex-end}
.alert{padding:12px;border-radius:4px;margin-bottom:16px}
.alert.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.alert.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.hidden{display:none}
.modal-content.wide{width:600px;max-width:90vw}
.stock-panel{background:#F5F9FF;border:1px solid #DDDDDD;border-radius:6px;padding:16px;margin-top:24px}
.stock-panel h3{margin-top:0;color:#0A1A2F}
.stock-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.stock-stat{background:#FFFFFF;padding:16px;border-radius:4px;text-align:center}
.stock-stat h4{margin:0 0 8px 0;color:#0A1A2F}
.stock-stat .number{font-size:24px;font-weight:bold;color:#13406a}
</style>
</head>
<body>
<header class="topbar">
<div class="logo-wrap">
<img class="logo" src="img/logo.png" alt="LogiTrack">
</div>
<div class="user-wrap">
<span id="welcomeText" class="welcome"></span>
<button id="logoutBtn" class="btn">Cerrar sesión</button>
</div>
</header>

<main class="content">
<nav class="menu">
<a href="dashboard.html" class="menu-item">Dashboard</a>
<a href="bodegas.html" class="menu-item">Bodegas</a>
<a href="productos.html" class="menu-item">Productos</a>
<a href="movimientos.html" class="menu-item">Movimientos</a>
<a href="reportes.html" class="menu-item">Reportes</a>
<a href="auditoria.html" class="menu-item admin-only">Auditoría</a>
<a href="usuarios.html" class="menu-item admin-only">Usuarios</a>
</nav>

<div class="panel">
<div id="alertContainer"></div>

<div class="panel-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
<h2>Gestión de Productos</h2>
<button id="btnNuevoProducto" class="btn primary admin-only">Nuevo Producto</button>
</div>

<div id="productosContainer">
<!-- Aquí va el fetch para cargar productos -->
<table class="table">
<thead>
<tr>
<th>ID</th>
<th>Nombre</th>
<th>Categoría</th>
<th>Stock</th>
<th>Precio</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="productosTableBody">
<tr>
<td colspan="6" style="text-align:center;padding:40px;color:#666">
Cargando productos...
</td>
</tr>
</tbody>
</table>
</div>

<div class="stock-panel">
<h3>Resumen de Stock</h3>
<div class="stock-stats">
<div class="stock-stat">
<h4>Stock Total</h4>
<div class="number" id="stockTotal">0</div>
</div>
<div class="stock-stat">
<h4>Productos Bajo Mínimo</h4>
<div class="number" id="productosBajoMinimo">0</div>
</div>
<div class="stock-stat">
<h4>Total de Productos</h4>
<div class="number" id="totalProductos">0</div>
</div>
</div>
</div>
</div>

<!-- Modal para nuevo producto -->
<div id="modalNuevoProducto" class="modal hidden">
<div class="modal-content">
<div class="modal-header">
<h3>Nuevo Producto</h3>
</div>
<div class="modal-body">
<form id="formNuevoProducto">
<div class="form-group">
<label for="nombre">Nombre:</label>
<input type="text" id="nombre" name="nombre" required>
</div>
<div class="form-group">
<label for="categoria">Categoría:</label>
<input type="text" id="categoria" name="categoria" required>
</div>
<div class="form-group">
<label for="stock">Stock:</label>
<input type="number" id="stock" name="stock" min="0" required>
</div>
<div class="form-group">
<label for="precio">Precio:</label>
<input type="number" id="precio" name="precio" min="0" step="0.01" required>
</div>
</form>
</div>
<div class="modal-actions">
<button type="button" class="btn" onclick="cerrarModal('modalNuevoProducto')">Cancelar</button>
<button type="submit" form="formNuevoProducto" class="btn primary">Guardar</button>
</div>
</div>
</div>

<!-- Modal para editar producto -->
<div id="modalEditarProducto" class="modal hidden">
<div class="modal-content">
<div class="modal-header">
<h3>Editar Producto</h3>
</div>
<div class="modal-body">
<form id="formEditarProducto">
<input type="hidden" id="editId" name="id">
<div class="form-group">
<label for="editNombre">Nombre:</label>
<input type="text" id="editNombre" name="nombre" required>
</div>
<div class="form-group">
<label for="editCategoria">Categoría:</label>
<input type="text" id="editCategoria" name="categoria" required>
</div>
<div class="form-group">
<label for="editStock">Stock:</label>
<input type="number" id="editStock" name="stock" min="0" required>
</div>
<div class="form-group">
<label for="editPrecio">Precio:</label>
<input type="number" id="editPrecio" name="precio" min="0" step="0.01" required>
</div>
</form>
</div>
<div class="modal-actions">
<button type="button" class="btn" onclick="cerrarModal('modalEditarProducto')">Cancelar</button>
<button type="submit" form="formEditarProducto" class="btn primary">Actualizar</button>
</div>
</div>
</div>
</main>

<script src="js/api.js"></script>
<script>
function parseJwt(t){try{const p=t.split('.')[1];const d=JSON.parse(atob(p));return d}catch(e){return null}}
const token=localStorage.getItem('token');
if(!token){window.location.href='index.html'}
const payload=parseJwt(token);
const name=(payload&&(payload.name||payload.username||payload.sub))||'Usuario';
const role=payload&&payload.role||'EMPLEADO';
document.getElementById('welcomeText').textContent='Bienvenido, '+name;
document.getElementById('logoutBtn').addEventListener('click',function(){localStorage.removeItem('token');localStorage.removeItem('username');window.location.href='index.html'});

// Control de acceso por rol
if(role!=='ADMIN'){
document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');
}

// Funciones de utilidad
function mostrarAlerta(mensaje,tipo='success'){
const container=document.getElementById('alertContainer');
const alert=document.createElement('div');
alert.className='alert '+tipo;
alert.textContent=mensaje;
container.innerHTML='';
container.appendChild(alert);
setTimeout(()=>alert.remove(),5000);
}

function cerrarModal(modalId){
document.getElementById(modalId).classList.add('hidden');
}

function actualizarResumenStock(productos){
  const stockTotal=productos.reduce((sum,p)=>sum+(p.stock||0),0);
  const productosBajoMinimo=productos.filter(p=>(p.stock||0)<10).length;
  const totalProductos=productos.length;
  document.getElementById('stockTotal').textContent=stockTotal;
  document.getElementById('productosBajoMinimo').textContent=productosBajoMinimo;
  document.getElementById('totalProductos').textContent=totalProductos;
}

function filaProducto(idx,p){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${idx}</td><td>${p.nombre}</td><td>${p.categoria}</td><td>${p.stock}</td><td>${p.precio}</td><td>
  ${role==='ADMIN'?`<button class="btn small" data-action="edit" data-id="${idx}">Editar</button>
  <button class="btn small" data-action="del" data-id="${idx}">Eliminar</button>`:''}
  </td>`;
  tr.dataset.rowId=idx;
  return tr;
}

async function cargarProductos(){
  try{
    const list=await apiRequest('GET','/api/productos/list-raw');
    const tbody=document.getElementById('productosTableBody');
    tbody.innerHTML='';
    list.forEach((p)=>{tbody.appendChild(filaProducto(p.id,p))});
    actualizarResumenStock(list);
  }catch(e){
    document.getElementById('productosTableBody').innerHTML='<tr><td colspan="6" style="text-align:center;padding:40px;color:#666">'+e.message+'</td></tr>';
  }
}

// Event listeners
// Aquí va el fetch para cargar productos
document.getElementById('btnNuevoProducto').addEventListener('click',function(){
  document.getElementById('modalNuevoProducto').classList.remove('hidden');
});

document.getElementById('formNuevoProducto').addEventListener('submit',async function(e){
  e.preventDefault();
  try{
    const dto={
      nombre:document.getElementById('nombre').value,
      categoria:document.getElementById('categoria').value,
      stock:parseInt(document.getElementById('stock').value,10),
      precio:parseFloat(document.getElementById('precio').value)
    };
    await apiRequest('POST','/api/productos',dto);
    cerrarModal('modalNuevoProducto');
    cargarProductos();
  }catch(err){mostrarAlerta(err.message,'error')}
});

document.getElementById('formEditarProducto').addEventListener('submit',async function(e){
  e.preventDefault();
  try{
    const id=parseInt(document.getElementById('editId').value,10);
    const dto={
      nombre:document.getElementById('editNombre').value,
      categoria:document.getElementById('editCategoria').value,
      stock:parseInt(document.getElementById('editStock').value,10),
      precio:parseFloat(document.getElementById('editPrecio').value)
    };
    await apiRequest('PUT',`/api/productos/${id}`,dto);
    cerrarModal('modalEditarProducto');
    cargarProductos();
  }catch(err){mostrarAlerta(err.message,'error')}
});

document.getElementById('productosTableBody').addEventListener('click',async function(e){
  const btn=e.target.closest('button');
  if(!btn)return;
  const id=parseInt(btn.getAttribute('data-id'),10);
  const action=btn.getAttribute('data-action');
  if(action==='edit' && role==='ADMIN'){
    document.getElementById('editId').value=id;
    document.getElementById('modalEditarProducto').classList.remove('hidden');
  } else if(action==='del' && role==='ADMIN'){
    try{await apiRequest('DELETE',`/api/productos/${id}`);cargarProductos()}catch(err){mostrarAlerta(err.message,'error')}
  }
});

window.addEventListener('DOMContentLoaded',function(){
  cargarProductos();
});
</script>
</body>
</html>